# Session 11: Subroutines and Multitasking

## Functions (part 1)

### Exercise: Review Code

Look at the code and find repetitions.

```c

void loop() {
    set_led_matrix_pixel(y, x, HIGH);
    show_led_matrix();
    delay(50);
    set_led_matrix_pixel(y + 1, x, HIGH);
    show_led_matrix();
    delay(50);
    set_led_matrix_pixel(y, x + 1, HIGH);
    show_led_matrix();
    delay(50);
    set_led_matrix_pixel(y, x + 2, HIGH);
    show_led_matrix();
    delay(50);
    set_led_matrix_pixel(y, x + 3, HIGH);
    show_led_matrix();
    delay(50);
    set_led_matrix_pixel(y + 1, x + 3, HIGH);
    show_led_matrix();
    delay(50);
    set_led_matrix_pixel(y - 1, x + 1, HIGH);
    show_led_matrix();
    delay(50);
    set_led_matrix_pixel(y - 1, x + 2, HIGH);
    show_led_matrix();
    delay(50);
}
```

### Simplification

<details>
	<summary> Simplified Code </summary>

```c
void showAndDelay(){
    show_led_matrix();
    delay(50);
}

void loop() {
    set_led_matrix_pixel(y, x, HIGH);
    showAndDelay();
    set_led_matrix_pixel(y + 1, x, HIGH);
    showAndDelay();
    set_led_matrix_pixel(y, x + 1, HIGH);
    showAndDelay();
    set_led_matrix_pixel(y, x + 2, HIGH);
    showAndDelay();
    set_led_matrix_pixel(y, x + 3, HIGH);
    showAndDelay();
    set_led_matrix_pixel(y + 1, x + 3, HIGH);
    showAndDelay();
    set_led_matrix_pixel(y - 1, x + 1, HIGH);
    showAndDelay();
    set_led_matrix_pixel(y - 1, x + 2, HIGH);
    showAndDelay();
}
```

</details>


### Semantic Functions

```c
// ...

int command = BTN_0;
void getCommand(){ // input: IR remote
    if(check_ir_button_pressed()){
        command = get_ir_button();
    }
}

void showAnimation(){ // output: matrix
    clear_led_matrix();
    for(int x=0; x<8; x++){
        set_led_matrix_pixel(x, 5, HIGH);
        delay(100);
    }
    show_led_matrix();
}

void showLight(){ // output: RGB LEDs
    set_led_color(LED_1, command, 0, 0);
    delay(500);
    set_led_color(LED_1, 0, command, 0);
    delay(500);
    set_led_color(LED_1, 0, 0, command);
    delay(500);
}

void loop(){
    getCommand();
    showAnimation();
    showLight();
}
```

## Multitasking

Good: Arduino processor frequency ~16MHz (empty `loop()` ~1MHz)

Problem: `delay()` in every loop

<details>
    <summary>
        loop frequency with delay(100)?
    </summary>

    Ans: 1/(100ms) = 10Hz
</details>

<details>
    <summary>
        What % of processor time is unused?
    </summary>

    1 - 10Hz/1MHz = 99.999%  
</details>


### Solution: `millis()`

```c
long time = millis(); // milliseconds since program start
```

### Code Snippets

#### concurrent `delay`

```c
long myFunctionTimer = 0;
void myFunction(){
    if(millis() > myFunctionTimer){
        // do stuff
        myFunctionTimer = millis() + 100;
    }
}
```

#### concurrent 'loops'

```c
int x = 0;
void animate(){

    show_led_matrix();
    set_led_matrix_pixel(x, 0, HIGH);

    x++;
    if (!(x<8)){
        x=0;
        clear_led_matrix();
    }

}
```

## Practical Exercise

1. Make your animation code concurrent.
1. Control your animation via user input.
1. Control another component via user input (e.g. RGB LEDs, Servos, ...)